# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: CI

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    - name: Install NuGet CLI
      run: sudo apt-get install -y nuget
    - name: Restore dependencies
      run: dotnet restore Reborn.IdentityServer4.Admin.sln
    - name: Build
      run: dotnet build Reborn.IdentityServer4.Admin.sln --configuration Release --no-restore
    - name: Test
      run: dotnet test Reborn.IdentityServer4.Admin.sln --configuration Release --no-build
    - name: Publish to NuGet
      run: .\nuget-publish.ps1 -apikey ${{ secrets.NUGET_API_KEY }}
      shell: pwsh
    - name: Commit version bump
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git add .
        git commit -m "Bump version [skip ci]"
        git push https://${{ secrets.GH_TOKEN }}@github.com/iamshen/Reborn.IdentityServer4.Admin.git master
    - name: Tag new version
      run: |
        $xml = New-Object System.Xml.XmlDocument
        $xml.LoadXml((Get-Content Reborn.IdentityServer4.Admin.Templates.nuspec))
        $version = $xml.GetElementsByTagName('version')[0].InnerText
        git tag "v$version"
        git push https://${{ secrets.GH_TOKEN }}@github.com/iamshen/Reborn.IdentityServer4.Admin.git "v$version"
      shell: pwsh
